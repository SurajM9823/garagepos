{% extends 'base.html' %}
{% load static %}

{% block title %}Staff Management - Garage POS{% endblock %}

{% block content %}
<div class="p-3 sm:p-4 space-y-3 max-w-7xl mx-auto bg-gray-100">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3 space-y-2 sm:space-y-0">
        <div>
            <h1 class="text-lg font-bold text-gray-900">Staff Management</h1>
            <p class="text-xs text-gray-600">Manage team members, assignments, and payroll</p>
        </div>
        <div class="flex space-x-2">
            <button id="add-staff-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-1.5 px-2 rounded-md text-xs font-medium transition-colors duration-200 flex items-center space-x-1">
                <i class="fas fa-plus w-3 h-3"></i>
                <span>Add Staff</span>
            </button>
            <button id="generate-payroll-btn" class="bg-purple-600 hover:bg-purple-700 text-white py-1.5 px-2 rounded-md text-xs font-medium transition-colors duration-200 flex items-center space-x-1">
                <i class="fas fa-file-csv w-3 h-3"></i>
                <span>Payroll Statement</span>
            </button>
        </div>
    </div>

    <!-- Search -->
    <div class="bg-white rounded-md shadow-sm border border-gray-200 p-2 mb-3">
        <div class="relative">
            <i class="fas fa-search absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400 w-3 h-3"></i>
            <input
                type="text"
                id="staff-search"
                placeholder="Search staff by name, email, role, or specialization..."
                class="w-full pl-7 pr-2 py-1 border border-gray-300 rounded-md text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
        </div>
    </div>

    <!-- Performance Alert -->
    <div id="low-performance-alert" class="hidden bg-yellow-50 border border-yellow-200 rounded-md p-2 mb-3">
        <div class="flex items-center">
            <i class="fas fa-exclamation-triangle w-4 h-4 text-yellow-600 mr-2"></i>
            <h3 class="text-xs font-medium text-yellow-800" id="low-performance-count"></h3>
        </div>
        <div class="mt-1 text-xs text-yellow-700" id="low-performance-staff"></div>
    </div>

    <!-- Staff Stats -->
    <div class="grid grid-cols-1 sm:grid-cols-4 gap-2 mb-3">
        <div class="bg-white rounded-md shadow-sm border border-gray-200 p-2">
            <div class="flex items-center">
                <i class="fas fa-users w-6 h-6 text-blue-600 mr-2"></i>
                <div>
                    <p class="text-xs text-gray-600">Active Staff</p>
                    <p class="text-lg font-bold text-gray-900" id="active-staff">0</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-md shadow-sm border border-gray-200 p-2">
            <div class="flex items-center">
                <i class="fas fa-motorcycle w-6 h-6 text-orange-600 mr-2"></i>
                <div>
                    <p class="text-xs text-gray-600">In Progress</p>
                    <p class="text-lg font-bold text-gray-900" id="in-progress">0</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-md shadow-sm border border-gray-200 p-2">
            <div class="flex items-center">
                <i class="fas fa-check-circle w-6 h-6 text-green-600 mr-2"></i>
                <div>
                    <p class="text-xs text-gray-600">Completed Today</p>
                    <p class="text-lg font-bold text-gray-900" id="completed-today">0</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-md shadow-sm border border-gray-200 p-2">
            <div class="flex items-center">
                <i class="fas fa-star w-6 h-6 text-purple-600 mr-2"></i>
                <div>
                    <p class="text-xs text-gray-600">Avg Rating</p>
                    <p class="text-lg font-bold text-gray-900" id="avg-rating">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-2 mb-3" id="staff-grid"></div>

    <!-- Add/Edit Staff Modal -->
    <div id="add-staff-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-3 z-50">
        <div class="bg-white rounded-md max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-4 py-2 flex justify-between items-center">
                <h2 class="text-sm font-semibold text-gray-900" id="staff-modal-title">Add New Staff Member</h2>
                <button id="close-staff-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times w-4 h-4"></i>
                </button>
            </div>
            <form id="staff-form" class="p-4 space-y-2">
                {% csrf_token %}
                <input type="hidden" id="staff-id" name="id">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Full Name *</label>
                    <input
                        type="text"
                        id="staff-name"
                        name="name"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Enter full name"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Email *</label>
                    <input
                        type="email"
                        id="staff-email"
                        name="email"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Enter email"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Phone Number *</label>
                    <input
                        type="tel"
                        id="staff-phone"
                        name="phone"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="e.g., +977 XXXXX XXXXX"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Password *</label>
                    <input
                        type="password"
                        id="staff-password"
                        name="password"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Password"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Role *</label>
                    <select id="staff-role" name="role" class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select role</option>
                        <option value="staff">Staff</option>
                        <option value="manager">Manager</option>
                        <option value="cashier">Cashier</option>
                        <option value="mechanic">Mechanic</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Experience</label>
                    <select id="experience-level" name="experience" class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select experience</option>
                        <option value="less-than-1-year">Less than 1 year</option>
                        <option value="1-2-years">1-2 years</option>
                        <option value="3-5-years">3-5 years</option>
                        <option value="5-plus">5+ years</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Specialization</label>
                    <input
                        type="text"
                        id="staff-specialization"
                        name="specialization"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="e.g., Engine Repair, Brake Systems"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Join Date</label>
                    <input
                        type="date"
                        id="staff-join-date"
                        name="join_date"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Base Salary (NPR)</label>
                    <input
                        type="number"
                        id="staff-salary"
                        name="base_salary"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="e.g., 30000"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Previous Dues (NPR)</label>
                    <input
                        type="number"
                        id="staff-dues"
                        name="previous_dues"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="e.g., 5000"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Status</label>
                    <select id="staff-status" name="status" class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="active">Active</option>
                        <option value="break">Break</option>
                        <option value="off">Off</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Profile Image</label>
                    <input
                        type="file"
                        id="staff-profile-image"
                        name="profile_image"
                        accept="image/*"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs"
                    />
                </div>
                <div class="sticky bottom-0 bg-gray-50 px-4 py-2 flex space-x-2">
                    <button id="cancel-staff-btn" type="button" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-1.5 px-2 rounded-md text-xs font-medium transition-colors duration-200">
                        Cancel
                    </button>
                    <button id="save-staff-btn" type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1.5 px-2 rounded-md text-xs font-medium transition-colors duration-200">
                        Save Staff
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payroll Modal -->
    <div id="payroll-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-3 z-50">
        <div class="bg-white rounded-md max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-4 py-2 flex justify-between items-center">
                <h2 class="text-sm font-semibold text-gray-900" id="payroll-title">Payroll Details</h2>
                <button id="close-payroll-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times w-4 h-4"></i>
                </button>
            </div>
            <div class="p-4 space-y-3">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <div>
                        <p class="text-xs font-medium text-gray-700">Base Salary</p>
                        <p class="text-xs font-bold text-gray-900" id="payroll-base-salary">NPR 0</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-700">Previous Dues</p>
                        <p class="text-xs font-bold text-gray-900" id="payroll-dues">NPR 0</p>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-700">Incentives</p>
                        <p class="text-xs font-bold text-gray-900" id="payroll-incentives">NPR 0</p>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-md p-2">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-xs font-medium text-gray-700">Total Payable</p>
                        <p class="text-xs font-bold text-blue-600" id="payroll-total">NPR 0</p>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-medium text-gray-900">Payment History</h3>
                    <button id="add-payment-btn" class="bg-green-600 hover:bg-green-700 text-white py-1 px-2 rounded-md text-xs font-medium transition-colors duration-200 flex items-center space-x-1">
                        <i class="fas fa-plus w-3 h-3"></i>
                        <span>Add Payment</span>
                    </button>
                </div>
                <div class="border border-gray-200 rounded-md overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-1 text-left text-xs font-medium text-gray-500">Date</th>
                                <th class="px-3 py-1 text-left text-xs font-medium text-gray-500">Amount</th>
                                <th class="px-3 py-1 text-left text-xs font-medium text-gray-500">Mode</th>
                                <th class="px-3 py-1 text-left text-xs font-medium text-gray-500">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="payment-history"></tbody>
                    </table>
                </div>
            </div>
            <div class="sticky bottom-0 bg-gray-50 px-4 py-2 flex space-x-2">
                <button id="close-payroll-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-1.5 px-2 rounded-md text-xs font-medium transition-colors duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="add-payment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-3 z-50">
        <div class="bg-white rounded-md max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-4 py-2 flex justify-between items-center">
                <h2 class="text-sm font-semibold text-gray-900">Add Payment</h2>
                <button id="close-payment-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times w-4 h-4"></i>
                </button>
            </div>
            <form id="payment-form" class="p-4 space-y-2">
                {% csrf_token %}
                <input type="hidden" id="payment-staff-id" name="user_id">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Payment Amount (NPR) *</label>
                    <input
                        type="number"
                        id="payment-amount"
                        name="amount"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="e.g., 5000"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Payment Mode *</label>
                    <select id="payment-mode" name="payment_mode" class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="cash">Cash</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="mobile">Mobile Payment (e.g., eSewa)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Notes</label>
                    <textarea
                        id="payment-notes"
                        name="notes"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Optional notes"
                        rows="3"
                    ></textarea>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Incentives (NPR)</label>
                    <input
                        type="number"
                        id="payment-incentives"
                        name="incentives"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="e.g., 1000"
                    />
                </div>
                <div class="sticky bottom-0 bg-gray-50 px-4 py-2 flex space-x-2">
                    <button id="cancel-payment-btn" type="button" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-1.5 px-2 rounded-md text-xs font-medium transition-colors duration-200">
                        Cancel
                    </button>
                    <button id="save-payment-btn" type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-1.5 px-2 rounded-md text-xs font-medium transition-colors duration-200">
                        Add Payment
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Attendance Modal -->
    <div id="attendance-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-3 z-50">
        <div class="bg-white rounded-md max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-4 py-2 flex justify-between items-center">
                <h2 class="text-sm font-semibold text-gray-900" id="attendance-title">Attendance Details</h2>
                <button id="close-attendance-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times w-4 h-4"></i>
                </button>
            </div>
            <div class="p-4 space-y-3">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex space-x-2">
                        <select id="attendance-month" class="border border-gray-300 rounded-md px-2 py-1 text-xs">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                        <input
                            type="number"
                            id="attendance-year"
                            class="border border-gray-300 rounded-md px-2 py-1 text-xs w-20"
                            placeholder="Year"
                            value="2025"
                        />
                        <button id="fetch-attendance-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 rounded-md text-xs font-medium">
                            Fetch
                        </button>
                    </div>
                    <button id="add-attendance-btn" class="bg-green-600 hover:bg-green-700 text-white py-1 px-2 rounded-md text-xs font-medium flex items-center space-x-1">
                        <i class="fas fa-plus w-3 h-3"></i>
                        <span>Add Attendance</span>
                    </button>
                </div>
                <div class="border border-gray-200 rounded-md overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-1 text-left text-xs font-medium text-gray-500">Date</th>
                                <th class="px-3 py-1 text-left text-xs font-medium text-gray-500">Status</th>
                                <th class="px-3 py-1 text-left text-xs font-medium text-gray-500">Check In</th>
                                <th class="px-3 py-1 text-left text-xs font-medium text-gray-500">Check Out</th>
                                <th class="px-3 py-1 text-left text-xs font-medium text-gray-500">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-history"></tbody>
                    </table>
                </div>
            </div>
            <div class="sticky bottom-0 bg-gray-50 px-4 py-2 flex space-x-2">
                <button id="close-attendance-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-1.5 px-2 rounded-md text-xs font-medium transition-colors duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Add Attendance Modal -->
    <div id="add-attendance-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-3 z-50">
        <div class="bg-white rounded-md max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-4 py-2 flex justify-between items-center">
                <h2 class="text-sm font-semibold text-gray-900">Add Attendance</h2>
                <button id="close-add-attendance-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times w-4 h-4"></i>
                </button>
            </div>
            <form id="attendance-form" class="p-4 space-y-2">
                {% csrf_token %}
                <input type="hidden" id="attendance-staff-id" name="user_id">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Date *</label>
                    <input
                        type="date"
                        id="attendance-date"
                        name="date"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Status *</label>
                    <select id="attendance-status" name="status" class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="present">Present</option>
                        <option value="absent">Absent</option>
                        <option value="leave">Leave</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Check In</label>
                    <input
                        type="datetime-local"
                        id="attendance-check-in"
                        name="check_in"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Check Out</label>
                    <input
                        type="datetime-local"
                        id="attendance-check-out"
                        name="check_out"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Notes</label>
                    <textarea
                        id="attendance-notes"
                        name="notes"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Optional notes"
                        rows="3"
                    ></textarea>
                </div>
                <div class="sticky bottom-0 bg-gray-50 px-4 py-2 flex space-x-2">
                    <button id="cancel-add-attendance-btn" type="button" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-1.5 px-2 rounded-md text-xs font-medium transition-colors duration-200">
                        Cancel
                    </button>
                    <button id="save-attendance-btn" type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-1.5 px-2 rounded-md text-xs font-medium transition-colors duration-200">
                        Save Attendance
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payroll Statement Modal -->
    <div id="payroll-statement-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-3 z-50">
        <div class="bg-white rounded-md max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-4 py-2 flex justify-between items-center">
                <h2 class="text-sm font-semibold text-gray-900">Generate Payroll Statement</h2>
                <button id="close-payroll-statement-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times w-4 h-4"></i>
                </button>
            </div>
            <form id="payroll-statement-form" class="p-4 space-y-2">
                {% csrf_token %}
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Select Staff *</label>
                    <select id="payroll-statement-staff" name="user_ids" multiple class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Month *</label>
                    <select id="payroll-statement-month" name="month" class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Year *</label>
                    <input
                        type="number"
                        id="payroll-statement-year"
                        name="year"
                        class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="e.g., 2025"
                        value="2025"
                    />
                </div>
                <div class="sticky bottom-0 bg-gray-50 px-4 py-2 flex space-x-2">
                    <button id="cancel-payroll-statement-btn" type="button" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-1.5 px-2 rounded-md text-xs font-medium transition-colors duration-200">
                        Cancel
                    </button>
                    <button id="generate-payroll-statement-btn" type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-1.5 px-2 rounded-md text-xs font-medium transition-colors duration-200">
                        Generate
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Helper functions
    function getStatusColor(status) {
        switch (status) {
            case 'active': return 'bg-green-100 text-green-800';
            case 'break': return 'bg-yellow-100 text-yellow-800';
            case 'off': return 'bg-gray-100 text-gray-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function getRoleColor(role) {
        switch (role) {
            case 'staff': return 'bg-blue-100 text-blue-800';
            case 'manager': return 'bg-green-100 text-green-800';
            case 'cashier': return 'bg-yellow-100 text-yellow-800';
            case 'mechanic': return 'bg-purple-100 text-purple-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function calculateProgress(completed, total) {
        return total > 0 ? Math.round((completed / total) * 100) : 0;
    }

    function showError(message) {
        alert(message);
    }

    function getCsrfToken() {
        const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        if (tokenElement) {
            return tokenElement.value;
        }
        console.warn('CSRF token not found in DOM. Attempting to get from cookies.');
        return getCookie('csrftoken');
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Fetch and render staff
    function fetchStaff(searchTerm = '') {
        fetch(`/admin/get-staff-list/?search=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                    return;
                }
                renderStaff(data.staff);
                updateStats(data.stats);
                updatePayrollStatementStaffOptions(data.staff);
            })
            .catch(error => showError('Failed to fetch staff: ' + error.message));
    }

    function renderStaff(staff) {
        const staffGrid = document.getElementById('staff-grid');
        staffGrid.innerHTML = staff.map(member => `
            <div class="bg-white rounded-md shadow-sm border border-gray-200 p-3 hover:shadow-md transition-shadow duration-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <div class="bg-blue-100 rounded-full p-2">
                            <i class="fas fa-user w-4 h-4 text-blue-600"></i>
                        </div>
                        <div>
                            <h3 class="text-xs font-semibold text-gray-900">${member.name}</h3>
                            <span class="inline-block px-1.5 py-0.5 rounded-full text-xs font-medium ${getRoleColor(member.role)}">
                                ${member.role.charAt(0).toUpperCase() + member.role.slice(1)}
                            </span>
                        </div>
                    </div>
                    <span class="px-1.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(member.status)}">
                        ${member.status.charAt(0).toUpperCase() + member.status.slice(1)}
                    </span>
                </div>
                <div class="space-y-1 mb-2">
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-envelope w-3 h-3 text-gray-400"></i>
                        <span class="text-xs text-gray-600">${member.email}</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-phone w-3 h-3 text-gray-400"></i>
                        <span class="text-xs text-gray-600">${member.phone || '-'}</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-wrench w-3 h-3 text-gray-400"></i>
                        <span class="text-xs text-gray-600">${member.specialization || 'General'}</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-clock w-3 h-3 text-gray-400"></i>
                        <span class="text-xs text-gray-600">${(member.experience || 'less-than-1-year').replace('-', ' ').charAt(0).toUpperCase() + (member.experience || 'less-than-1-year').replace('-', ' ').slice(1)} experience</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-star w-3 h-3 text-gray-400"></i>
                        <span class="text-xs text-gray-600">Rating: ${member.rating.toFixed(1)}/5.0</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-calendar w-3 h-3 text-gray-400"></i>
                        <span class="text-xs text-gray-600">Joined: ${member.join_date}</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-money-bill w-3 h-3 text-gray-400"></i>
                        <span class="text-xs text-gray-600">Salary: NPR ${member.base_salary.toLocaleString()}</span>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-md p-2 mb-2">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-medium text-gray-700">Current Orders</span>
                        <span class="text-xs text-gray-500">${member.current_orders.length} assigned</span>
                    </div>
                    ${member.current_orders.length > 0 ? `
                        <div class="space-y-1">
                            ${member.current_orders.map(order => `
                                <span class="inline-block bg-blue-100 text-blue-800 text-xs px-1.5 py-0.5 rounded mr-1">${order}</span>
                            `).join('')}
                        </div>
                    ` : `<span class="text-xs text-gray-600">No current assignments</span>`}
                </div>
                <div class="bg-gray-50 rounded-md p-2 mb-2">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-medium text-gray-700">Task Progress</span>
                        <span class="text-xs text-gray-600">${calculateProgress(member.completed_total, member.completed_total + member.in_progress)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                        <div class="h-1.5 rounded-full ${calculateProgress(member.completed_total, member.completed_total + member.in_progress) > 80 ? 'bg-green-500' : calculateProgress(member.completed_total, member.completed_total + member.in_progress) > 50 ? 'bg-blue-500' : 'bg-yellow-500'}" style="width: ${calculateProgress(member.completed_total, member.completed_total + member.in_progress)}%"></div>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button class="edit-btn flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 px-2 rounded-md text-xs font-medium transition-colors duration-200 flex items-center justify-center space-x-1" data-id="${member.id}">
                        <i class="fas fa-edit w-3 h-3"></i>
                        <span>Edit</span>
                    </button>
                    <button class="delete-btn flex-1 bg-red-600 hover:bg-red-700 text-white py-1 px-2 rounded-md text-xs font-medium transition-colors duration-200 flex items-center justify-center space-x-1" data-id="${member.id}">
                        <i class="fas fa-trash w-3 h-3"></i>
                        <span>Delete</span>
                    </button>
                    <button class="payroll-btn flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 rounded-md text-xs font-medium transition-colors duration-200 flex items-center justify-center space-x-1" data-id="${member.id}">
                        <i class="fas fa-money-bill w-3 h-3"></i>
                        <span>Payroll</span>
                    </button>
                    <button class="attendance-btn flex-1 bg-purple-600 hover:bg-purple-700 text-white py-1 px-2 rounded-md text-xs font-medium transition-colors duration-200 flex items-center justify-center space-x-1" data-id="${member.id}">
                        <i class="fas fa-calendar-check w-3 h-3"></i>
                        <span>Attendance</span>
                    </button>
                </div>
            </div>
        `).join('');

        // Attach event listeners
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const member = staff.find(s => s.id == btn.dataset.id);
                document.getElementById('staff-modal-title').textContent = 'Edit Staff Member';
                document.getElementById('staff-id').value = member.id;
                document.getElementById('staff-name').value = member.name;
                document.getElementById('staff-email').value = member.email;
                document.getElementById('staff-phone').value = member.phone || '';
                document.getElementById('staff-role').value = member.role;
                document.getElementById('experience-level').value = member.experience || '';
                document.getElementById('staff-specialization').value = member.specialization || '';
                document.getElementById('staff-join-date').value = member.join_date;
                document.getElementById('staff-salary').value = member.base_salary;
                document.getElementById('staff-dues').value = member.previous_dues;
                document.getElementById('staff-status').value = member.status;
                document.getElementById('staff-profile-image').value = '';
                document.getElementById('staff-password').value = '';
                document.getElementById('add-staff-modal').classList.remove('hidden');
            });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!confirm('Are you sure you want to delete this staff member?')) return;
                const formData = new FormData();
                formData.append('id', btn.dataset.id);
                formData.append('csrfmiddlewaretoken', getCsrfToken());
                fetch('/admin/delete-staff/', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showError(data.error);
                        } else {
                            alert(data.message);
                            fetchStaff(document.getElementById('staff-search').value);
                        }
                    })
                    .catch(error => showError('Failed to delete staff: ' + error.message));
            });
        });

        document.querySelectorAll('.payroll-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                fetch(`/admin/get-payroll/?user_id=${btn.dataset.id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showError(data.error);
                            return;
                        }
                        const member = staff.find(s => s.id == btn.dataset.id);
                        document.getElementById('payroll-title').textContent = `Payroll Details - ${member.name}`;
                        document.getElementById('payroll-base-salary').textContent = `NPR ${data.base_salary.toLocaleString()}`;
                        document.getElementById('payroll-dues').textContent = `NPR ${data.previous_dues.toLocaleString()}`;
                        document.getElementById('payroll-incentives').textContent = `NPR ${data.incentives.toLocaleString()}`;
                        document.getElementById('payroll-total').textContent = `NPR ${data.total_payable.toLocaleString()}`;
                        document.getElementById('payment-history').innerHTML = data.payments.map(payment => `
                            <tr class="border-t border-gray-200">
                                <td class="px-3 py-1 text-xs text-gray-600">${payment.date}</td>
                                <td class="px-3 py-1 text-xs text-gray-600">NPR ${payment.amount.toLocaleString()}</td>
                                <td class="px-3 py-1 text-xs text-gray-600">${payment.payment_mode.charAt(0).toUpperCase() + payment.payment_mode.slice(1)}</td>
                                <td class="px-3 py-1 text-xs text-gray-600">${payment.notes || '-'}</td>
                            </tr>
                        `).join('');
                        document.getElementById('payment-staff-id').value = btn.dataset.id;
                        document.getElementById('payroll-modal').classList.remove('hidden');
                    })
                    .catch(error => showError('Failed to fetch payroll: ' + error.message));
            });
        });

        document.querySelectorAll('.attendance-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const member = staff.find(s => s.id == btn.dataset.id);
                document.getElementById('attendance-title').textContent = `Attendance Details - ${member.name}`;
                document.getElementById('attendance-staff-id').value = btn.dataset.id;
                document.getElementById('attendance-month').value = new Date().getMonth() + 1;
                document.getElementById('attendance-year').value = new Date().getFullYear();
                fetchAttendance(btn.dataset.id);
                document.getElementById('attendance-modal').classList.remove('hidden');
            });
        });
    }

    function updateStats(stats) {
        document.getElementById('active-staff').textContent = stats.active_staff;
        document.getElementById('in-progress').textContent = stats.in_progress;
        document.getElementById('completed-today').textContent = stats.completed_today;
        document.getElementById('avg-rating').textContent = stats.avg_rating.toFixed(1);
        document.getElementById('low-performance-alert').classList.toggle('hidden', stats.low_performance.length === 0);
        document.getElementById('low-performance-count').textContent = `Low Performance Alert: ${stats.low_performance.length} staff need attention`;
        document.getElementById('low-performance-staff').textContent = stats.low_performance.join(', ');
    }

    function updatePayrollStatementStaffOptions(staff) {
        const select = document.getElementById('payroll-statement-staff');
        select.innerHTML = staff.map(member => `
            <option value="${member.id}">${member.name} (${member.role})</option>
        `).join('');
    }

    function fetchAttendance(userId) {
        const month = document.getElementById('attendance-month').value;
        const year = document.getElementById('attendance-year').value;
        fetch(`/admin/get-attendance/?user_id=${userId}&month=${month}&year=${year}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                    return;
                }
                document.getElementById('attendance-history').innerHTML = data.attendances.map(a => `
                    <tr class="border-t border-gray-200">
                        <td class="px-3 py-1 text-xs text-gray-600">${a.date}</td>
                        <td class="px-3 py-1 text-xs text-gray-600">${a.status.charAt(0).toUpperCase() + a.status.slice(1)}</td>
                        <td class="px-3 py-1 text-xs text-gray-600">${a.check_in || '-'}</td>
                        <td class="px-3 py-1 text-xs text-gray-600">${a.check_out || '-'}</td>
                        <td class="px-3 py-1 text-xs text-gray-600">${a.notes || '-'}</td>
                    </tr>
                `).join('');
            })
            .catch(error => showError('Failed to fetch attendance: ' + error.message));
    }

    // Event listeners
    document.getElementById('staff-search').addEventListener('input', (e) => fetchStaff(e.target.value));

    document.getElementById('add-staff-btn').addEventListener('click', () => {
    document.getElementById('staff-modal-title').textContent = 'Add New Staff Member';
    document.getElementById('staff-id').value = '';
    document.getElementById('staff-name').value = '';
    document.getElementById('staff-email').value = '';
    document.getElementById('staff-phone').value = '';
    document.getElementById('staff-role').value = '';
    document.getElementById('experience-level').value = '';
    document.getElementById('staff-specialization').value = '';
    document.getElementById('staff-join-date').value = '';
    document.getElementById('staff-salary').value = '';
    document.getElementById('staff-dues').value = '';
    document.getElementById('staff-status').value = 'active';
    document.getElementById('staff-profile-image').value = '';
    document.getElementById('staff-password').value = '';
    document.getElementById('add-staff-modal').classList.remove('hidden');
});

    document.getElementById('close-staff-modal').addEventListener('click', () => {
    document.getElementById('add-staff-modal').classList.add('hidden');
});

document.getElementById('cancel-staff-btn').addEventListener('click', () => {
    document.getElementById('add-staff-modal').classList.add('hidden');
});

document.getElementById('staff-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    fetch('/admin/save-staff/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                alert(data.message);
                document.getElementById('add-staff-modal').classList.add('hidden');
                fetchStaff(document.getElementById('staff-search').value);
            }
        })
        .catch(error => showError('Failed to save staff: ' + error.message));
});

document.getElementById('add-payment-btn').addEventListener('click', () => {
    document.getElementById('payment-amount').value = '';
    document.getElementById('payment-mode').value = 'cash';
    document.getElementById('payment-notes').value = '';
    document.getElementById('payment-incentives').value = '';
    document.getElementById('add-payment-modal').classList.remove('hidden');
});

document.getElementById('close-payment-modal').addEventListener('click', () => {
    document.getElementById('add-payment-modal').classList.add('hidden');
});

document.getElementById('cancel-payment-btn').addEventListener('click', () => {
    document.getElementById('add-payment-modal').classList.add('hidden');
});

document.getElementById('payment-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    fetch('/admin/save-payroll/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                alert(data.message);
                document.getElementById('add-payment-modal').classList.add('hidden');
                document.getElementById('payroll-modal').classList.add('hidden');
                fetchStaff(document.getElementById('staff-search').value);
            }
        })
        .catch(error => showError('Failed to save payment: ' + error.message));
});

document.getElementById('close-payroll-btn').addEventListener('click', () => {
    document.getElementById('payroll-modal').classList.add('hidden');
});

document.getElementById('close-payroll-modal').addEventListener('click', () => {
    document.getElementById('payroll-modal').classList.add('hidden');
});

document.getElementById('add-attendance-btn').addEventListener('click', () => {
    document.getElementById('attendance-date').value = '';
    document.getElementById('attendance-status').value = 'present';
    document.getElementById('attendance-check-in').value = '';
    document.getElementById('attendance-check-out').value = '';
    document.getElementById('attendance-notes').value = '';
    document.getElementById('add-attendance-modal').classList.remove('hidden');
});

document.getElementById('close-attendance-modal').addEventListener('click', () => {
    document.getElementById('attendance-modal').classList.add('hidden');
});

document.getElementById('close-attendance-btn').addEventListener('click', () => {
    document.getElementById('attendance-modal').classList.add('hidden');
});

document.getElementById('close-add-attendance-modal').addEventListener('click', () => {
    document.getElementById('add-attendance-modal').classList.add('hidden');
});

document.getElementById('cancel-add-attendance-btn').addEventListener('click', () => {
    document.getElementById('add-attendance-modal').classList.add('hidden');
});

document.getElementById('attendance-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    fetch('/admin/save-attendance/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                alert(data.message);
                document.getElementById('add-attendance-modal').classList.add('hidden');
                fetchAttendance(document.getElementById('attendance-staff-id').value);
            }
        })
        .catch(error => showError('Failed to save attendance: ' + error.message));
});

document.getElementById('fetch-attendance-btn').addEventListener('click', () => {
    fetchAttendance(document.getElementById('attendance-staff-id').value);
});

document.getElementById('generate-payroll-btn').addEventListener('click', () => {
    document.getElementById('payroll-statement-month').value = new Date().getMonth() + 1;
    document.getElementById('payroll-statement-year').value = new Date().getFullYear();
    document.getElementById('payroll-statement-modal').classList.remove('hidden');
});

document.getElementById('close-payroll-statement-modal').addEventListener('click', () => {
    document.getElementById('payroll-statement-modal').classList.add('hidden');
});

document.getElementById('cancel-payroll-statement-btn').addEventListener('click', () => {
    document.getElementById('payroll-statement-modal').classList.add('hidden');
});

document.getElementById('payroll-statement-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const userIds = Array.from(document.getElementById('payroll-statement-staff').selectedOptions).map(option => option.value);
    formData.set('user_ids', JSON.stringify(userIds));
    fetch('/admin/generate-payroll-statement/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Failed to generate payroll statement');
                });
            }
            return response.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `payroll_statement_${formData.get('month')}-${formData.get('year')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            document.getElementById('payroll-statement-modal').classList.add('hidden');
        })
        .catch(error => showError(error.message));
});
    // Initial fetch
    fetchStaff();
</script>
{% endblock %}